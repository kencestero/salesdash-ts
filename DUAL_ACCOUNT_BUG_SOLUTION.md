# DUAL ACCOUNT BUG - COMPLETE SOLUTION

**Date:** October 22, 2025, 5:30 AM
**Problem:** OAuth and Email signup create incomplete accounts

---

## üî¥ ROOT CAUSE IDENTIFIED

### Email Signup (WORKS ‚úÖ)
- Stores ALL data in `PendingUser` table
- Includes: firstName, lastName, phone, zipcode, **managerId**, **status**, role
- Email verification creates User + UserProfile with **rep code**

### OAuth Signup (BROKEN ‚ùå)
- Only stores firstName, lastName, phone, zipcode in cookies
- **MISSING:** managerId, status cookies
- **MISSING:** Rep code generation in signIn callback
- Result: Profile exists but NO rep code, NO manager link

---

## ‚úÖ SOLUTION - 3 CODE FIXES

### Fix 1: Add Manager & Status Cookies Before OAuth

**File:** `app/[lang]/auth/join/page.tsx`
**Function:** `handleSocialSignup` (line 184)

**ADD THESE LINES after existing cookies:**

```typescript
// ‚úÖ NEW: Store manager ID and status
document.cookie = `signup_managerId=${encodeURIComponent(managerId || "")}; path=/; max-age=900`;
document.cookie = `signup_status=${encodeURIComponent(isFreelancer ? "freelancer" : "employee")}; path=/; max-age=900`;
```

**Also add validation BEFORE OAuth:**

```typescript
// ‚úÖ NEW: Validate manager selection for non-freelancers
if (!isFreelancer && !managerId) {
  setErr("Please select your manager or check the Freelancer option");
  return;
}
```

---

### Fix 2: Read Manager/Status & Generate Rep Code in SignIn Callback

**File:** `lib/auth.ts`
**Function:** `signIn` callback (line 100-142)

**ADD AFTER reading existing cookies:**

```typescript
const managerId = cookies().get("signup_managerId")?.value;
const status = cookies().get("signup_status")?.value || "employee";

// ‚úÖ Generate rep code (same logic as email verification)
let repCode: string;
if (status === "freelancer") {
  repCode = "REP000000";
} else {
  // Generate unique 6-digit code
  let isUnique = false;
  repCode = "";
  while (!isUnique) {
    const randomDigits = Math.floor(100000 + Math.random() * 900000).toString();
    repCode = `REP${randomDigits}`;
    const existing = await prisma.userProfile.findUnique({ where: { repCode } });
    if (!existing) isUnique = true;
  }
}
```

**UPDATE UserProfile.create() to include:**

```typescript
await prisma.userProfile.create({
  data: {
    // ... existing fields ...
    repCode: repCode,  // ‚úÖ ADD THIS
    managerId: managerId ? decodeURIComponent(managerId) : null,  // ‚úÖ ADD THIS
    status: status,  // ‚úÖ ADD THIS
  },
});
```

**DELETE new cookies after user creation:**

```typescript
cookies().delete("signup_managerId");
cookies().delete("signup_status");
```

---

### Fix 3: Create Shared Rep Code Utility (OPTIONAL BUT RECOMMENDED)

**Create new file:** `lib/repCode.ts`

```typescript
import { prisma } from "@/lib/prisma";

export async function generateUniqueRepCode(status: string): Promise<string> {
  if (status === "freelancer") return "REP000000";

  let isUnique = false;
  let repCode = "";

  while (!isUnique) {
    const randomDigits = Math.floor(100000 + Math.random() * 900000).toString();
    repCode = `REP${randomDigits}`;
    const existing = await prisma.userProfile.findUnique({ where: { repCode } });
    if (!existing) isUnique = true;
  }

  return repCode;
}
```

**Then use in both places:**
- `app/api/auth/verify/route.ts` - Replace rep code logic with: `await generateUniqueRepCode(pendingUser.status)`
- `lib/auth.ts` - Replace rep code logic with: `await generateUniqueRepCode(status)`

---

## üìã TESTING CHECKLIST

After implementing fixes:

1. ‚úÖ Email signup creates complete profile (firstName, lastName, phone, zipcode, managerId, status, repCode, role)
2. ‚úÖ Google OAuth creates complete profile (all same fields)
3. ‚úÖ GitHub OAuth creates complete profile (all same fields)
4. ‚úÖ Freelancers get "REP000000"
5. ‚úÖ Employees get unique "REP######" codes
6. ‚úÖ Manager links stored correctly in database
7. ‚úÖ Rep code shows on dashboard for ALL users
8. ‚úÖ Profile button visible for ALL users

---

## üîß FILES TO MODIFY

| File | Action | Lines |
|------|--------|-------|
| `app/[lang]/auth/join/page.tsx` | Add cookies + validation | ~200-210 |
| `lib/auth.ts` | Read cookies, generate repCode | ~115-142 |
| `lib/repCode.ts` | Create new utility file | New |
| `app/api/auth/verify/route.ts` | Use shared utility (optional) | ~94-113 |

---

## üöÄ PRIORITY: FIX THIS FIRST

This is blocking new user signups! Uncle's account is broken, Kenneth's main account is incomplete.

**Estimated time:** 30 minutes to implement + test

---

**Generated by:** Browser Claude Code Research Agent
**For:** Papi Claude (Claude Desktop)
