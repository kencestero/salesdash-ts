// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NextAuth.js Models
// Docs: https://next-auth.js.org/adapters/prisma

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id               String    @id @default(cuid())
  name             String?
  email            String?   @unique
  emailVerified    DateTime?
  password         String?   // For email/password authentication
  image            String?
  resetToken       String?   @unique // Password reset token
  resetTokenExpiry DateTime? // Token expiration time
  createdAt        DateTime  @default(now())
  currentChallenge String?   // WebAuthn challenge for passkey registration/authentication
  updatedAt        DateTime  @updatedAt

  accounts          Account[]
  sessions          Session[]
  profile           UserProfile?
  trailerRequests   TrailerRequest[]
  chatParticipants  ChatParticipant[]
  credentials       WebAuthnCredential[]
  chatMessages      ChatMessage[]
  sentMessages      InternalMessage[]  @relation("SentMessages")
  receivedMessages  InternalMessage[]  @relation("ReceivedMessages")
  createdLeads      Lead[]             @relation("CreatedLeads")
  pushSubscriptions PushSubscription[] @relation("PushSubscriptions")
  deliveryRecords   DeliveryRecord[]   @relation("CreatedDeliveryRecords")
  dashboardVisits   DashboardVisit[]
  notifications     Notification[]
  notificationPreferences NotificationPreference?

  // Social & Gamification System
  friendships       Friendship[]       @relation("UserFriendships")
  friendOf          Friendship[]       @relation("FriendOf")
  blockedUsers      BlockedUser[]      @relation("UserBlocks")
  blockedBy         BlockedUser[]      @relation("BlockedBy")
  managedTeam       Team?              @relation("TeamManager")
  teamMembership    TeamMember?        @relation("TeamMemberships")
  earnedBadges      UserBadge[]        @relation("UserBadges")
  monthlyGoals      MonthlyGoal[]      @relation("MonthlyGoals")
  goalsSetForOthers MonthlyGoal[]      @relation("GoalsSetBy")
  trainingCompletions TrainingCompletion[] @relation("TrainingCompletions")
  salesStats        SalesStats?        @relation("SalesStats")

  // Contractor Documents
  contractorDocuments ContractorDocument[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Pending User - For "Verify First, Then Create Account" flow
model PendingUser {
  id             String   @id @default(cuid())
  email          String   @unique
  hashedPassword String
  firstName      String
  lastName       String
  phone          String?
  zipcode        String?
  role           String   @default("salesperson") // "owner", "manager", "salesperson"
  managerId      String?  // Selected manager's User ID during signup
  status         String   @default("employee") // "employee" or "freelancer"
  token          String   @unique
  expiresAt      DateTime
  createdAt      DateTime @default(now())

  @@index([token])
  @@index([email])
  @@index([expiresAt])
  @@map("pending_users")
}

// Remotive SalesHub Models

model UserProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  firstName       String?
  lastName        String?
  preferredName   String?  // Preferred name / nickname
  phone           String?
  zipcode         String?
  city            String?
  about           String?  @db.Text // Professional bio / about section
  avatarUrl       String?  @db.Text // Profile avatar/photo URL
  coverUrl        String?  @db.Text // Profile cover/banner image URL
  zip             String?  // Legacy field, use zipcode instead
  salespersonCode String?  @unique // REP12345, SMR12345, or VIP12345
  role            String   @default("salesperson") // "owner", "manager", "salesperson", "director"
  member          Boolean  @default(false) // Join code verified
  needsJoinCode   Boolean  @default(false) // OAuth users who signed up without join code

  // Rep Tracking & Organization
  repCode         String?  @unique // Format: "REP" + 6 digits (e.g., "REP482756"), "REP000000" for freelancers
  managerId       String?  // Links to another User's id (their manager)
  status          String   @default("employee") // "employee" or "freelancer"

  // User Status Controls
  accountStatus   String   @default("active") // "active", "banned", "timeout", "muted"
  banReason       String?  // Reason for ban/timeout
  timeoutUntil    DateTime? // When timeout expires (null if not on timeout)
  mutedUntil      DateTime? // When mute expires (null if not muted)

  // Granular Permissions
  canAccessCRM        Boolean @default(true)
  canAccessInventory  Boolean @default(true)
  canAccessConfigurator Boolean @default(true) // Finance Calculator
  canAccessCalendar   Boolean @default(true)
  canAccessReports    Boolean @default(false) // Advanced reports
  canManageUsers      Boolean @default(false) // Only for owners/directors
  canAdminCRM         Boolean @default(false) // CRM Admin: intake team, can manage imports, settings, audit logs

  // Manager System Controls
  isAvailableAsManager Boolean @default(false) // Can appear in manager dropdown during signup
  isActive            Boolean @default(true)   // Account active status (for soft-delete/suspension)

  // Payplan Acceptance Fields
  payplanStatus       String    @default("PENDING")  // "PENDING" | "ACCEPTED" | "DECLINED"
  payplanVersion      String?                         // e.g., "2026-01-11-v1"
  payplanAcceptedAt   DateTime?
  payplanDeclinedAt   DateTime?

  // User Presence Tracking (for chat online/offline status)
  lastSeen   DateTime  @default(now())
  isOnline   Boolean   @default(false)

  // CRM Preferences (JSON - user-specific settings)
  // Structure: { defaultViewId, defaultSort, followUpDays, overdueReminders, emailSignature, fromNameFormat }
  crmPreferences  Json?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([role])
  @@index([member])
  @@index([salespersonCode])
  @@index([repCode])
  @@index([managerId])
  @@index([accountStatus])
}

// Inventory Management
model Trailer {
  id              String   @id @default(cuid())
  vin             String   @unique // Vehicle Identification Number
  stockNumber     String   @unique // Internal stock number

  // Basic Info
  manufacturer    String   // e.g., "Big Tex", "PJ Trailers"
  model           String
  year            Int
  category        String   // e.g., "Utility", "Dump", "Enclosed", "Gooseneck"

  // Specifications
  length          Float    // in feet
  width           Float    // in feet
  height          Float?   // in feet
  gvwr            Int?     // Gross Vehicle Weight Rating (lbs)
  capacity        Int?     // payload capacity (lbs)
  axles           Int?     // number of axles
  rearDoorType    String?  // Rear door code: R, DD, HDR, SRW, 8'P, R-RW

  // Pricing
  msrp            Float    // Manufacturer's Suggested Retail Price
  salePrice       Float    // Current sale price
  cost            Float    // Dealer cost (sensitive!)
  makeOffer       Boolean  @default(false) // If true, display "MAKE OFFER" instead of sale price
  pricingStatus   String   @default("PRICED") // "PRICED" or "ASK_FOR_PRICING" (when cost is textual)

  // Status
  status          String   @default("available") // "available", "sold", "reserved", "pending"
  location        String?  // Physical location (lot, warehouse)

  // Media
  images          String[] // Array of image URLs
  description     String?  @db.Text
  features        String[] // Array of feature strings

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?  // User ID who added it
  soldAt          DateTime?
  soldBy          String?  // Salesperson ID who sold it

  // Soft-delete & Batch Tracking
  importBatchId   String?   @db.VarChar(36) // UUID for tracking bulk imports
  deletedAt       DateTime? // Soft-delete timestamp

  // Relations
  deals           Deal[]
  creditApps      CreditApplication[]
  quotes          Quote[]

  @@index([status])
  @@index([category])
  @@index([manufacturer])
  @@index([importBatchId])
  @@index([deletedAt])
  @@index([soldBy])
}

// CRM - Customer Relationship Management
model Customer {
  id              String   @id @default(cuid())

  // Personal Info
  firstName       String
  lastName        String
  email           String?  @unique
  phone           String?

  // Address
  street          String?
  city            String?
  state           String?
  zipcode         String?

  // Business Info
  companyName     String?
  businessType    String?

  // Lead Management - NEW FIELDS
  assignedTo      String?  // KEEP FOR NOW - will migrate to assignedToId
  assignedToId    String?  // Primary salesperson ID
  assignedToName  String?  // Primary salesperson name (Assigned Manager - Column F)
  salesRepName    String?  // Sales Rep name (Column B)
  backupRepId     String?  // Secondary rep if needed
  lastContactDate DateTime?
  nextFollowUpDate DateTime?

  // Lead Info
  source          String?
  status          String   @default("new") // "new", "contacted", "qualified", "applied", "approved", "dead", "won"

  // Advanced Lead Tracking (VinSolutions-level features)
  leadScore       Int      @default(0) // 0-100 scoring system
  temperature     String   @default("warm") // "hot", "warm", "cold", "dead"
  priority        String   @default("medium") // "low", "medium", "high", "urgent"
  daysInStage     Int      @default(0) // Days in current status
  responseTime    Int?     // Minutes from lead creation to first contact
  lastActivityAt  DateTime? // Last time ANY activity occurred (call, email, note, etc.)

  // Bidirectional Sync Tracking
  lastSyncedToSheets DateTime? // When we last synced this record to Google Sheets
  syncStatus      String   @default("pending") // "pending", "synced", "failed"

  // Trailer Requirements - NEW FIELDS
  trailerSize     String?
  trailerType     String?
  stockNumber     String?
  financingType   String?  // "cash", "finance", "rto"
  isFactoryOrder  Boolean  @default(false) // KEEPING for backward compatibility

  // Credit Application Status - NEW FIELDS
  hasAppliedCredit Boolean @default(false)
  creditAppStatus String?  // "not_applied", "applied", "approved", "declined"
  applied         Boolean @default(false) // Google Sheets Column H - Applied status
  dateApplied     DateTime? // Google Sheets Column I - Date Applied
  linkSentStatus  String   @default("not_sent") // "applied", "not_applied", "not_sent", "cash_deal"
  approvalStatus  String   @default("status") // "status", "approved", "pending", "need_docs", "denied" (legacy)
  rtoApprovalStatus     String?  // "approved", "pending", "need_stips", "declined" - RTO specific
  financeApprovalStatus String?  // "approved", "pending", "need_stips", "declined" - Regular financing specific

  // Pre-Qualification Router Data (from website form)
  creditRange     String?  // "excellent_780_plus", "good_700_779", "fair_650_699", "below_average_620_649", "rebuilding_below_620"
  recommendedPath String?  // "rock_solid", "lease_to_own"
  sourcePage      String?  // "/get-approved", etc.
  ctaClicked      String?  // Which CTA button customer clicked
  repCode         String?  // Rep code from the link (for tracking)

  // Duplicate Lead Handling
  duplicateStatus String   @default("none") // "none", "pending_review", "resolved"
  duplicateOfId   String?  // ID of original lead if this is a duplicate
  lockedForReview Boolean  @default(false)  // Prevents edits until manager reviews
  lockedAt        DateTime?
  lockReason      String?  // "duplicate", "fraud_check", etc.
  reviewedByUserId String? // Manager who reviewed the duplicate
  reviewDecision  String?  // "keep_original", "reassign_to_new", "merge"
  reviewedAt      DateTime?

  // Trailer Identification (Batch 1 - CRM Enhancement)
  vin               String?  // Free text VIN, trim + uppercase on save

  // Lost Lead Tracking (Batch 1 - CRM Enhancement)
  lostReason        String?  // "price" | "no_credit" | "bought_elsewhere" | "no_response" | "other"
  lostReasonNotes   String?  // Required when lostReason = "other"

  // Assignment Tracking (Batch 1 - CRM Enhancement)
  managerId         String?  // Explicit manager tracking (manager's userId)
  assignmentMethod  String?  // "repCode" | "intake" | "manual" | "bulk_reassign"

  // Tags for segmentation
  tags            String[]

  // Notes
  notes           String?  @db.Text
  managerNotes    String?  @db.Text // Google Sheets Column K - Manager Notes
  repNotes        String?  @db.Text // Google Sheets Column L - Rep Notes

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastContactedAt DateTime?

  // Relations
  deals           Deal[]
  creditApps      CreditApplication[]
  activities      Activity[]
  emails          Email[]
  quotes          Quote[]
  leadNotes       LeadNote[]
  interests       CustomerInterest[]  // Batch 2D: Customer interest in specific trailers
  messageThreads  MessageThread[]     // Reply Portal: Messaging threads with this customer

  @@index([email])
  @@index([status])
  @@index([assignedTo])
  @@index([assignedToId])
  @@index([nextFollowUpDate])
  @@index([hasAppliedCredit])
  @@index([leadScore])
  @@index([temperature])
  @@index([priority])
  @@index([lastActivityAt])
  @@index([syncStatus])
  @@index([assignedToId, status]) // Composite: for rep's pipeline view
  @@index([temperature, leadScore]) // Composite: for hot leads dashboard
  @@index([duplicateStatus])        // For finding leads pending review
  @@index([lockedForReview])        // For finding locked leads
  @@index([repCode])                // For tracking leads by rep code
  @@index([vin])                    // For VIN search (Batch 1)
  @@index([lostReason])             // For lost reason filtering (Batch 1)
  @@index([managerId])              // For manager assignment queries (Batch 1)
}

// Delivery Records - Track actual delivered trailers
model DeliveryRecord {
  id                  String   @id @default(cuid())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Basic delivery information
  customerName        String
  trailerIdentifier   String   // VIN, stock number, or unit number (string for now)
  deliveryDate        DateTime

  // Financial tracking
  commissionAmount    Decimal  @db.Decimal(12, 2)
  profitAmount        Decimal  @db.Decimal(12, 2)

  // Who logged this delivery
  createdByUserId     String?
  createdByUser       User?    @relation("CreatedDeliveryRecords", fields: [createdByUserId], references: [id])

  @@index([createdByUserId])
  @@index([deliveryDate])
  @@index([trailerIdentifier])
}

// Deal/Opportunity Tracking
model Deal {
  id              String   @id @default(cuid())

  // Customer & Trailer
  customerId      String
  trailerId       String?  // Nullable in case of custom orders

  // Deal Info
  dealNumber      String   @unique
  status          String   @default("pending") // "pending", "financing", "approved", "closed", "sold", "lost"
  dealType        String   // "cash", "finance", "trade"

  // Pricing
  offeredPrice    Float
  finalPrice      Float?
  tradeInValue    Float?
  tradeInDesc     String?  @db.Text
  deposit         Float?

  // Finance Info
  financeAmount   Float?
  downPayment     Float?
  apr             Float?
  term            Int?     // months
  monthlyPayment  Float?

  // Ownership
  salespersonId   String
  managerId       String?  // Manager who approved

  // Timeline
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  closedAt        DateTime?
  expectedCloseDate DateTime?

  // Notes
  notes           String?  @db.Text

  // ========== MARK AS SOLD FIELDS ==========
  // Delivery & Sale Info
  deliveryDate      DateTime?    // When customer took delivery
  soldByUserId      String?      // User ID of salesperson who sold
  soldByRepCode     String?      // Rep code (e.g., "REP482756")
  soldByName        String?      // Denormalized name for display

  // Trailer snapshot at time of sale (for historical record)
  trailerVin          String?    // VIN (auto-populated, editable)
  trailerCost         Float?     // Cost at time of sale
  trailerManufacturer String?    // e.g., "Diamond Cargo"
  trailerCategory     String?    // e.g., "Enclosed"
  trailerSize         String?    // e.g., "8.5 x 20"
  trailerAxles        Int?       // Number of axles
  trailerColor        String?    // From features array
  trailerHeight       Float?     // Height if available
  trailerStockNumber  String?    // Stock number

  // Profit tracking
  profit            Float?       // finalPrice - trailerCost
  profitMargin      Float?       // Percentage ((finalPrice - cost) / cost * 100)

  // Audit trail for mark as sold
  markedSoldAt      DateTime?    // When marked as sold
  markedSoldBy      String?      // User ID who marked as sold

  // Relations
  customer        Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  trailer         Trailer? @relation(fields: [trailerId], references: [id])

  @@index([customerId])
  @@index([trailerId])
  @@index([salespersonId])
  @@index([status])
  @@index([deliveryDate])
  @@index([soldByUserId])
  @@index([markedSoldAt])
}

// Deal Number Counter (for sequential deal numbers)
model DealCounter {
  id         String   @id @default("deal_counter")
  lastNumber Int      @default(0)
  updatedAt  DateTime @updatedAt
}

// Credit Application System
model CreditApplication {
  id              String   @id @default(cuid())
  appNumber       String   @unique

  // Shareable Link
  shareToken      String?  @unique // For public access
  shareEnabled    Boolean  @default(true)
  expiresAt       DateTime? // Optional expiration

  // Customer Info
  customerId      String?  // Optional - public forms may create new customers
  trailerId       String?

  // Personal Info (from form)
  firstName       String
  lastName        String
  email           String
  phone           String
  street          String?
  city            String?
  state           String?
  zipcode         String?

  ssn             String?  // Encrypted! Handle with care
  dob             DateTime?
  driverLicense   String?
  dlState         String?

  // Employment
  employer        String?
  jobTitle        String?
  employmentYears Int?
  monthlyIncome   Float?

  // Housing
  housingStatus   String?  // "own", "rent", "other"
  monthlyPayment  Float?
  yearsAtAddress  Int?

  // Equipment Details
  requestedAmount Float?
  requestedTerm   Int?      // months
  equipmentType   String?   // "utility", "dump", "enclosed", etc.
  equipmentDesc   String?   @db.Text

  // References
  references      Json?    // Array of reference objects

  // E-Signature & Legal
  signatureData   String?  @db.Text // Base64 signature image
  signedAt        DateTime?
  ipAddress       String?
  userAgent       String?
  legalConsent    Boolean  @default(false)
  legalText       String?  @db.Text // What they agreed to

  // Status
  status          String   @default("pending") // "pending", "submitted", "approved", "declined", "needs_review"
  submittedAt     DateTime?
  decidedAt       DateTime?

  // Approval Details
  approvedAmount  Float?
  approvedTerm    Int?
  approvedApr     Float?
  lender          String?  // Which finance company approved

  // Notes
  notes           String?  @db.Text

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?  // Salesperson who created it (nullable for public submissions)

  // Relations
  customer        Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  trailer         Trailer? @relation(fields: [trailerId], references: [id])

  @@index([customerId])
  @@index([status])
  @@index([createdBy])
  @@index([shareToken])
  @@index([email])
}

// Activity Tracking (for CRM)
model Activity {
  id              String   @id @default(cuid())

  // Related To
  customerId      String?
  userId          String?  // User who performed activity
  emailId         String?  // Link to Email record (for email activities)

  // Activity Details
  type            String   // "call", "email", "meeting", "note", "task"
  subject         String
  description     String?  @db.Text

  // Status (for tasks)
  status          String?  // "pending", "completed", "cancelled"
  dueDate         DateTime?
  completedAt     DateTime?

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  customer        Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([userId])
  @@index([emailId])
  @@index([type])
  @@index([dueDate])
  @@index([createdAt])              // Index for analytics queries
  @@index([customerId, createdAt]) // Composite index for customer activity timeline
  @@index([userId, createdAt])     // Composite index for user activity history
}

// Email System
model Email {
  id              String   @id @default(cuid())

  // Email Details
  from            String
  to              String[]
  cc              String[]
  bcc             String[]
  subject         String
  body            String   @db.Text
  htmlBody        String?  @db.Text

  // Attachments
  attachments     Json?    // Array of attachment metadata

  // Status
  status          String   @default("draft") // "draft", "sent", "failed", "scheduled"
  sentAt          DateTime?
  scheduledFor    DateTime?

  // Tracking
  opened          Boolean  @default(false)
  openedAt        DateTime?
  clicked         Boolean  @default(false)
  clickedAt       DateTime?

  // Relations
  customerId      String?
  userId          String   // User who sent/created

  // Template
  templateId      String?

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  customer        Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@index([customerId])
  @@index([userId])
  @@index([status])
  @@index([sentAt])
}

// Email Templates
model EmailTemplate {
  id              String   @id @default(cuid())
  name            String
  subject         String
  body            String   @db.Text
  htmlBody        String?  @db.Text

  // Variables (e.g., {{firstName}}, {{trailerModel}})
  variables       String[]

  // Category
  category        String?  // "follow-up", "thank-you", "reminder", "marketing"

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String

  @@index([category])
}

// Finance Quote System
enum PricingMode {
  CASH
  FINANCE
  RTO
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  CONVERTED
  EXPIRED
  REJECTED
}

enum QuoteAction {
  CREATED
  VIEWED_BY_REP
  VIEWED_BY_CUSTOMER
  EDITED
  LINK_GENERATED
  LINK_CLICKED
  PDF_GENERATED
  PDF_DOWNLOADED
  EMAIL_SENT
  SMS_SENT
  FORMULA_COPIED
  ACCEPTED
  REJECTED
  EXPIRED
  CONVERTED_TO_SALE
}

model Quote {
  id              String       @id @default(cuid())
  userId          String       // Rep who created the quote
  salespersonCode String       // Rep's unique code for filtering

  // Related entities
  trailerId       String?
  trailer         Trailer?     @relation(fields: [trailerId], references: [id])

  customerId      String?
  customer        Customer?    @relation(fields: [customerId], references: [id])

  // Pricing mode
  mode            PricingMode  @default(FINANCE)

  // Shared fields
  unitPrice       Float
  downPayment     Float        @default(0)
  taxRate         Float        // Percentage (e.g., 8.25)
  fees            Float        @default(0)
  termMonths      Int

  // Finance-specific fields
  apr             Float?
  monthlyPayment  Float?
  totalInterest   Float?
  principal       Float?

  // RTO-specific fields
  monthlyRent     Float?
  monthlyTax      Float?
  docFee          Float?
  buyoutFee       Float?
  rtoPrice        Float?

  // Cash-specific
  totalCash       Float?

  // Status and lifecycle
  status          QuoteStatus  @default(DRAFT)
  expiresAt       DateTime

  // Sharing settings
  shareToken      String?      @unique
  shareEnabled    Boolean      @default(false)
  visibilitySettings Json?     // { showAPR: false, showFees: true, ... }

  // Metadata
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  activities      QuoteActivity[]

  @@index([salespersonCode])
  @@index([status])
  @@index([trailerId])
  @@index([customerId])
  @@index([userId])
  @@index([expiresAt])
  @@index([userId, createdAt])        // Composite index for user quote history
  @@index([salespersonCode, status])  // Composite index for rep quote filtering
}

model QuoteActivity {
  id            String      @id @default(cuid())
  quoteId       String
  quote         Quote       @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  // Actor information
  userId        String?
  salespersonCode String?
  actorType     String      // "REP" | "CUSTOMER" | "SYSTEM"
  actorName     String?

  // Action details
  action        QuoteAction
  changes       Json?       // Field-level changes for EDITED action

  // Request metadata
  ipAddress     String?
  userAgent     String?
  durationMs    Int?        // Time spent viewing (for VIEWED actions)

  // Timestamp
  occurredAt    DateTime    @default(now())

  @@index([quoteId])
  @@index([salespersonCode])
  @@index([action])
  @@index([occurredAt])
}

model PricingPolicy {
  id                    Int      @id @default(1)

  // RTO defaults
  rtoBaseMarkupUsd      Float    @default(1400)
  rtoMonthlyFactor      Float    @default(0.035)  // 3.5%
  rtoMinDownUsd         Float    @default(200)
  rtoDocFeeUsd          Float    @default(99)
  rtoBuyoutFeeUsd       Float    @default(250)
  rtoDefaultTermMonths  Int      @default(36)

  // Finance defaults
  defaultApr            Float    @default(8.99)
  defaultTermMonths     Int      @default(60)

  // Cash defaults
  defaultFees           Float    @default(125)

  // Quote settings
  quoteExpirationDays   Int      @default(90)

  updatedAt             DateTime @updatedAt
}

// Inventory Upload Report System
model UploadReport {
  id                String   @id @default(cuid())

  // Upload Info
  fileName          String
  manufacturer      String   // "Diamond Cargo", "Quality Cargo", etc.
  uploadedBy        String   // User ID who uploaded

  // Summary Stats
  totalInUpload     Int      // Total trailers in the uploaded file
  newTrailers       Int      // Newly added trailers (VINs not in DB before)
  updatedTrailers   Int      // Existing trailers that were updated
  removedTrailers   Int      // Trailers that were in DB but not in upload (potentially sold)

  // Detailed Lists (stored as JSON for flexibility)
  newVins           String[] // Array of newly added VIN numbers
  updatedVins       String[] // Array of updated VIN numbers
  removedVins       String[] // Array of removed VIN numbers (potentially sold)

  // Additional metadata
  processingTime    Int?     // Time taken to process in milliseconds
  errors            Json?    // Any errors encountered during processing

  // Timestamps
  createdAt         DateTime @default(now())

  @@index([manufacturer])
  @@index([uploadedBy])
  @@index([createdAt])
}

// Import Log - Track each inventory import for rollback capability
model ImportLog {
  id        String   @id @default(cuid())
  batchId   String   @unique // UUID for the import batch
  supplier  String   // "Diamond Cargo", "Quality Cargo", "Panther Cargo"
  created   Int      // Number of new trailers created
  updated   Int      // Number of existing trailers updated
  skipped   Int      // Number of rows skipped (invalid data)
  userId    String   // User ID who performed the import
  createdAt DateTime @default(now())

  @@index([batchId])
  @@index([userId])
  @@index([createdAt])
}

// Calendar & Events System
model CalendarEvent {
  id              String   @id @default(cuid())

  // Event Details
  title           String
  description     String?  @db.Text
  start           DateTime
  end             DateTime
  allDay          Boolean  @default(false)

  // Event Type & Category
  eventType       String   // "personal" or "company"
  category        String   // "business", "personal", "holiday", "family", "meeting", "etc"

  // Ownership & Permissions
  userId          String?  // User who owns it (null for company-wide events)
  createdBy       String   // User ID who created it
  createdByRole   String?  // Role of creator ("owner", "manager", "salesperson")

  // Company Announcement specific fields
  isAnnouncement  Boolean  @default(false)
  visibleToRoles  String[] // Empty array = visible to all roles

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Indexes
  @@index([userId])
  @@index([eventType])
  @@index([category])
  @@index([start])
  @@index([end])
  @@index([isAnnouncement])
}

// Lead Notes - Separate from general notes for better tracking
model LeadNote {
  id              String   @id @default(cuid())

  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  authorId        String   // Who wrote the note
  authorName      String   // Display name of author
  authorRole      String   // "salesperson", "manager", "director", "owner"

  content         String   @db.Text
  noteType        String   @default("general") // "general", "follow_up", "manager_review", "status_change"

  isPrivate       Boolean  @default(false) // For sensitive notes

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([customerId])
  @@index([authorId])
  @@index([createdAt])
}

model TrailerRequest {
  id           String   @id @default(cuid())
  userId       String
  manufacturer String
  purpose      String
  vin          String?
  message      String   @db.Text
  status       String   @default("pending")
  assignedTo   String?
  response     String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id])
  @@index([status])
}

// Request Tool - Public request submissions
enum RequestStatus {
  PENDING
  SENT
  FAILED
}

model RequestLog {
  id                String        @id @default(cuid())
  createdAt         DateTime      @default(now())
  email             String
  fullName          String
  zip               String?
  manufacturer      String
  purpose           String
  message           String        @db.Text
  lang              String        @default("en")
  ip                String?
  userAgent         String?
  status            RequestStatus @default(PENDING)
  error             String?

  // Rep tracking fields
  submittedByUserId String?       // Salesperson who submitted
  submittedByName   String?       // Salesperson full name
  submittedByEmail  String?       // Salesperson email
  repCode           String?       // REP482756
  managerId         String?       // Manager's User ID
  managerNotified   Boolean       @default(false) // Was manager notified?

  @@index([createdAt])
  @@index([email])
  @@index([manufacturer])
  @@index([purpose])
  @@index([submittedByUserId])
  @@index([repCode])
  @@index([managerId])
}

// Help Center System
model HelpArticle {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  content     String   @db.Text
  excerpt     String?  @db.Text
  category    String   // "request-tool", "crm", "inventory", "finance", "general", etc.
  keywords    String[] // For search optimization
  isPinned    Boolean  @default(false) // Show at top of search results
  isPublished Boolean  @default(true)
  viewCount   Int      @default(0)
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String   // User ID who created
  
  @@index([category])
  @@index([isPublished])
  @@index([isPinned])
  @@index([slug])
}

// Real-Time Chat System
model ChatThread {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  subject   String?

  // Group Chat Fields
  isGroup      Boolean  @default(false)
  groupName    String?
  groupAvatar  String?
  isPublic     Boolean  @default(false)
  inviteToken  String?  @unique
  createdBy    String?  // User ID who created the group

  participants ChatParticipant[]
  messages     ChatMessage[]

  @@index([isGroup])
  @@index([isPublic])
  @@index([inviteToken])
}

model ChatParticipant {
  id         String     @id @default(cuid())
  thread     ChatThread @relation(fields: [threadId], references: [id])
  threadId   String
  userId     String // maps to User.id
  user       User       @relation(fields: [userId], references: [id])
  isAdmin    Boolean    @default(false) // Group chat admin privileges
  lastReadAt DateTime?  // Track when user last viewed this thread (for unread counts)

  @@unique([threadId, userId])
  @@index([threadId])
  @@index([userId])
}

model ChatMessage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  body      String   @db.Text
  senderId  String   // maps to User.id
  sender    User     @relation(fields: [senderId], references: [id])

  thread   ChatThread @relation(fields: [threadId], references: [id])
  threadId String

  attachments ChatAttachment[]

  @@index([threadId])
  @@index([senderId])
}

model ChatAttachment {
  id        String      @id @default(cuid())
  fileUrl   String
  fileName  String
  mimeType  String
  message   ChatMessage @relation(fields: [messageId], references: [id])
  messageId String

  @@index([messageId])
}

// Sync Log for tracking Google Sheets import runs
model SyncLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  startedAt DateTime
  durationMs Int
  scanned   Int
  inserted  Int
  updated   Int
  skipped   Int
  errors    Int
  errorDetails Json?
  actor     String   // email or 'token' if using token auth
  source    String   @default("google_sheets") // for future extensibility
  
  @@index([createdAt])
  @@index([source])
}

// WebAuthn Credentials (Passkeys)
model WebAuthnCredential {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  credentialId   String   @unique    // base64url
  publicKey      String               // base64url
  counter        Int
  deviceType     String?
  backedUp       Boolean?
  transports     String?              // json array string
  createdAt      DateTime @default(now())
  lastUsedAt     DateTime @updatedAt

  @@index([userId])
}

// Internal Messaging System (for header inbox dropdown)
model InternalMessage {
  id          String   @id @default(cuid())
  senderId    String
  receiverId  String
  subject     String?
  message     String   @db.Text
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  sender      User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver    User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([read])
  @@index([createdAt])
  @@map("internal_messages")
}

// Google Sheets Lead Import System
model Lead {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  source      String   @default("google-sheet")
  name        String?
  email       String?
  phone       String?
  zip         String?
  city        String?
  state       String?
  note        String?
  importHash  String   @unique
  createdById String?
  createdBy   User?    @relation("CreatedLeads", fields: [createdById], references: [id])
  events      LeadEvent[]

  @@index([email])
  @@index([phone])
  @@index([zip])
}

model LeadEvent {
  id        String   @id @default(cuid())
  leadId    String
  type      String
  details   String?
  createdAt DateTime @default(now())
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
}

// Push Notification Subscriptions
model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation("PushSubscriptions", fields: [userId], references: [id], onDelete: Cascade)

  endpoint  String   @unique
  p256dh    String   // Public key
  auth      String   // Auth secret

  // Preferences
  emailNotifications  Boolean  @default(true)
  pushNotifications   Boolean  @default(true)
  notifyNewLeads      Boolean  @default(true)
  notifyStatusChanges Boolean  @default(true)
  notifyStaleLeads    Boolean  @default(true)
  notifyDailyDigest   Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastUsedAt DateTime?

  @@index([userId])
  @@index([endpoint])
}

// Analytics: Dashboard Visits
model DashboardVisit {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([userId, createdAt])
}

// ===========================================
// NOTIFICATION SYSTEM
// ===========================================

enum NotificationType {
  // CRM Notifications (Priority A-E)
  CUSTOMER_ASSIGNED      // A - Someone assigned a customer to you
  CREDIT_APP_SUBMITTED   // B - Customer submitted credit app
  CREDIT_APP_APPROVED    // B - Credit app approved
  CREDIT_APP_DECLINED    // B - Credit app declined
  FOLLOW_UP_DUE          // C - Time to follow up with customer
  DUPLICATE_DETECTED     // D - Someone tried to add your customer
  STATUS_CHANGED         // E - Manager changed customer status
  CUSTOMER_REPLY         // Customer sent a reply via portal

  // System Notifications
  SYSTEM_ANNOUNCEMENT    // News from management
  TIP                    // Dashboard tips (complete profile, etc.)
  MEETING                // Meeting announcements
  NEW_FEATURE            // New tools/features available
  WELCOME                // Welcome message for new users
}

model Notification {
  id          String           @id @default(cuid())
  userId      String           // Recipient
  type        NotificationType
  title       String
  message     String           @db.Text
  data        Json?            // Additional context (customerId, creditAppId, etc.)
  read        Boolean          @default(false)
  readAt      DateTime?
  emailSent   Boolean          @default(false)
  emailSentAt DateTime?
  actionUrl   String?          // URL to navigate to when clicked
  createdAt   DateTime         @default(now())

  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([userId, createdAt])
  @@index([type])
  @@index([createdAt])
}

model NotificationPreference {
  id                    String   @id @default(cuid())
  userId                String   @unique

  // Channel toggles
  inAppEnabled          Boolean  @default(true)
  emailEnabled          Boolean  @default(true)

  // CRM Notifications
  customerAssigned      Boolean  @default(true)
  creditAppUpdates      Boolean  @default(true)
  followUpReminders     Boolean  @default(true)
  duplicateAlerts       Boolean  @default(true)
  statusChanges         Boolean  @default(true)
  customerReplies       Boolean  @default(true)  // Reply portal messages

  // System Notifications
  systemAnnouncements   Boolean  @default(true)
  tipsAndTricks         Boolean  @default(true)

  // Quiet Hours (future enhancement)
  quietHoursEnabled     Boolean  @default(false)
  quietHoursStart       String?  // "22:00" format
  quietHoursEnd         String?  // "08:00" format

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// CRM Saved Views - User-defined filter presets (Batch 2C)
model SavedView {
  id          String   @id @default(cuid())
  name        String
  filters     Json     // Serialized FilterState object
  userId      String?  // null = global/shared view
  isGlobal    Boolean  @default(false)
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([isGlobal])
}

// Customer Interest - Track customer interest in specific trailers (Batch 2D)
model CustomerInterest {
  id          String   @id @default(cuid())
  customerId  String
  stockNumber String?
  vin         String?
  notes       String?  @db.Text
  createdAt   DateTime @default(now())

  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([stockNumber])
  @@index([vin])
}

// ===========================================
// REPLY PORTAL - Customer Messaging System
// ===========================================

// Direction of message flow
enum MessageDirection {
  INBOUND   // Customer -> Rep
  OUTBOUND  // Rep -> Customer
}

// Channel the message came through
enum MessageChannel {
  PORTAL    // Customer reply portal (tokenized link)
  EMAIL     // Traditional email
  SYSTEM    // System-generated (auto-replies, etc.)
}

// Thread containing messages between rep and customer
model MessageThread {
  id              String    @id @default(cuid())
  customerId      String
  assignedToId    String    // Primary sales rep (User.id)
  managerId       String?   // Manager for visibility (User.id)

  // Thread metadata
  subject         String?   // Optional subject line

  // Thread state
  lastMessageAt     DateTime  @default(now())
  lastMessagePreview String?  @db.VarChar(200) // First 200 chars of last message
  unreadForRep      Boolean   @default(false)  // Rep has unread messages
  unreadForManager  Boolean   @default(false)  // Manager has unread messages

  // Token for customer portal access
  portalToken       String    @unique @default(cuid()) // Unique token for customer to access thread
  portalTokenExpiry DateTime? // Optional expiration for extra security

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  customer        Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  messages        Message[]

  @@index([customerId])
  @@index([assignedToId])
  @@index([managerId])
  @@index([portalToken])
  @@index([lastMessageAt])
  @@index([assignedToId, unreadForRep])   // For rep inbox query
  @@index([managerId, unreadForManager])  // For manager oversight
}

// Individual message in a thread
model Message {
  id          String           @id @default(cuid())
  threadId    String
  customerId  String           // Denormalized for easier queries

  // Direction and channel
  direction   MessageDirection
  channel     MessageChannel

  // Sender/receiver info
  fromName    String?
  fromEmail   String?
  toName      String?
  toEmail     String?

  // Message content
  bodyText    String           @db.Text
  bodyHtml    String?          @db.Text  // For rich email content

  // Metadata
  metadata    Json?            // Additional context (IP, user agent for portal, email headers, etc.)

  // Timestamps
  createdAt   DateTime         @default(now())

  // Read tracking
  readByRepAt     DateTime?    // When rep read this message
  readByManagerAt DateTime?    // When manager read this message

  // Relations
  thread      MessageThread    @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId])
  @@index([customerId])
  @@index([direction])
  @@index([createdAt])
  @@index([threadId, createdAt])  // For message history ordering
}

// =============================================================================
// CRM SETTINGS & AUDIT LOG (Batch 3)
// =============================================================================

// CRM Settings - Database-backed configuration for governance
model CRMSetting {
  id          String   @id @default(cuid())
  key         String   @unique  // e.g., "require_rep_for_contacted", "sla_new_lead_seconds"
  value       Json                // Flexible value storage
  category    String              // "assignment" | "sla" | "required_fields" | "import" | "dedupe"
  description String?             // Human-readable description
  updatedAt   DateTime @updatedAt
  updatedBy   String?             // User ID who last changed this setting

  @@index([category])
}

// Audit Log - Track all CRM changes for governance/policing
model AuditLog {
  id          String   @id @default(cuid())
  userId      String              // Who performed the action
  userEmail   String              // Denormalized for easy display
  userName    String?             // Denormalized for easy display

  action      String              // "assignment_change" | "status_change" | "delete" | "settings_change" | "bulk_action"
  entityType  String              // "Customer" | "CRMSetting" | "User" | "SavedView"
  entityId    String              // ID of the affected entity

  oldValue    Json?               // State before change
  newValue    Json?               // State after change

  ipAddress   String?             // Request IP for security audit
  userAgent   String?             // Browser/client info

  createdAt   DateTime @default(now())

  @@index([entityType, entityId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([entityType, createdAt])  // For filtering by entity type + time range
}

// =============================================================================
// PROFILE SOCIAL SYSTEM (Friends, Teams, Badges, Goals)
// =============================================================================

// Friend relationships - bidirectional social connections
model Friendship {
  id          String   @id @default(cuid())
  userId      String              // User who initiated
  friendId    String              // User being friended
  status      String   @default("pending") // "pending", "accepted", "declined"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User @relation("UserFriendships", fields: [userId], references: [id], onDelete: Cascade)
  friend      User @relation("FriendOf", fields: [friendId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
  @@index([userId])
  @@index([friendId])
  @@index([status])
}

// Block list - users who are blocked from contacting
model BlockedUser {
  id          String   @id @default(cuid())
  userId      String              // User who blocked
  blockedId   String              // User who is blocked
  reason      String?             // Optional reason
  createdAt   DateTime @default(now())

  user        User @relation("UserBlocks", fields: [userId], references: [id], onDelete: Cascade)
  blocked     User @relation("BlockedBy", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([userId, blockedId])
  @@index([userId])
  @@index([blockedId])
}

// Teams - Manager-based teams (auto-created when someone becomes a manager)
model Team {
  id          String   @id @default(cuid())
  name        String              // e.g., "Ken's Team", "Danielle's Team"
  description String?  @db.Text
  managerId   String   @unique    // The manager who owns this team (links to User.id)
  image       String?             // Team avatar/image
  color       String?  @default("#E96114") // Team color for badges
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  manager     User @relation("TeamManager", fields: [managerId], references: [id], onDelete: Cascade)
  members     TeamMember[]

  @@index([managerId])
  @@index([isActive])
}

// Team members - Links users to teams (max 10 per team)
model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  role      String   @default("member") // "member" or "lead"
  joinedAt  DateTime @default(now())

  team      Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User @relation("TeamMemberships", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@unique([userId]) // A user can only be on ONE team
  @@index([teamId])
}

// Badge definitions - Types of badges that can be earned
model Badge {
  id          String   @id @default(cuid())
  name        String   @unique    // e.g., "10 Units Sold", "Enclosed Trailer Expert"
  description String?  @db.Text
  icon        String?             // Icon name or URL
  color       String?  @default("#E96114")
  category    String              // "sales_milestone", "trailer_type", "experience", "certification"
  requirement Int?                // Number required to earn (e.g., 10 for "10 Units Sold")
  trailerType String?             // For trailer-type badges (e.g., "6x10", "Enclosed")
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())

  earnedBy    UserBadge[]

  @@index([category])
  @@index([isActive])
}

// User badges - Badges earned by users
model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String
  earnedAt  DateTime @default(now())
  metadata  Json?                // Extra data (e.g., which trailers counted toward this)

  user      User @relation("UserBadges", fields: [userId], references: [id], onDelete: Cascade)
  badge     Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
  @@index([earnedAt])
}

// Monthly sales goals - Set by reps on 1st of month, editable by managers until 20th
model MonthlyGoal {
  id          String   @id @default(cuid())
  userId      String
  month       Int                 // 1-12
  year        Int
  targetUnits Int                 // 1-99 units
  actualUnits Int      @default(0)
  isLocked    Boolean  @default(false) // Locked after 20th of month
  setByUserId String?             // Who set this goal (rep or manager)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User @relation("MonthlyGoals", fields: [userId], references: [id], onDelete: Cascade)
  setBy       User? @relation("GoalsSetBy", fields: [setByUserId], references: [id])

  @@unique([userId, month, year])
  @@index([userId])
  @@index([month, year])
}

// Training completion tracking - For Academy Certified badge
model TrainingCompletion {
  id          String   @id @default(cuid())
  userId      String
  moduleName  String              // e.g., "Sales Fundamentals", "Finance Options", "Product Knowledge"
  completedAt DateTime @default(now())
  score       Int?                // Optional quiz score
  certificateUrl String?          // Link to certificate if generated

  user        User @relation("TrainingCompletions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleName])
  @@index([userId])
}

// Sales stats cache - Aggregated stats for quick profile display
model SalesStats {
  id              String   @id @default(cuid())
  userId          String   @unique
  totalUnitsSold  Int      @default(0)
  totalRevenue    Float    @default(0)
  totalProfit     Float    @default(0)
  avgDealSize     Float    @default(0)

  // By trailer type counts
  enclosedCount   Int      @default(0)
  utilityCount    Int      @default(0)
  dumpCount       Int      @default(0)
  flatbedCount    Int      @default(0)
  otherCount      Int      @default(0)

  // By size counts (for badges)
  size6x10Count   Int      @default(0)
  size6x12Count   Int      @default(0)
  size7x14Count   Int      @default(0)
  size7x16Count   Int      @default(0)
  size8x16Count   Int      @default(0)
  size8x20Count   Int      @default(0)
  size8x24Count   Int      @default(0)
  otherSizeCount  Int      @default(0)

  // Time-based
  monthlyUnits    Int      @default(0) // Current month
  yearlyUnits     Int      @default(0) // Current year

  // Experience
  firstSaleAt     DateTime?
  lastSaleAt      DateTime?

  updatedAt       DateTime @updatedAt

  user            User @relation("SalesStats", fields: [userId], references: [id], onDelete: Cascade)

  @@index([totalUnitsSold])
  @@index([monthlyUnits])
}

// Help content - Contextual help for each section
model HelpContent {
  id          String   @id @default(cuid())
  section     String   @unique    // e.g., "profile_friends", "profile_teams", "monthly_goal"
  title       String
  content     String   @db.Text   // Markdown content
  rules       String?  @db.Text   // Rules/guidelines in markdown
  videoUrl    String?             // Optional tutorial video
  isActive    Boolean  @default(true)
  updatedAt   DateTime @updatedAt

  @@index([section])
}

// =============================================================================
// CONTRACTOR DOCUMENTS - Secure W-9 & Agreement Upload with Google Drive Sync
// =============================================================================

model ContractorDocument {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  docType       String   // "W9" | "CONTRACTOR_AGREEMENT"
  fileName      String   // Original filename
  storedPath    String?  // Local/S3 path (if using primary storage)
  driveFileId   String?  // Google Drive file ID
  driveUrl      String?  // Google Drive web view link (internal only - NOT exposed to reps)
  uploadedAt    DateTime @default(now())
  fileSize      Int      // Bytes
  mimeType      String   // "application/pdf", "image/jpeg", etc.

  @@index([userId])
  @@index([docType])
  @@index([uploadedAt])
}

// =============================================================================
// ONE-TIME ONBOARDING TOKEN SYSTEM
// Entry tokens for secure rep onboarding flow
// =============================================================================

model OnboardingToken {
  id          String    @id @default(cuid())
  token       String    @unique       // Unique entry token (nanoid)
  type        String    @default("rep") // "rep" or "manager" (future)
  used        Boolean   @default(false)
  usedAt      DateTime?
  createdBy   String                  // User ID of owner/director who created it
  createdAt   DateTime  @default(now())
  expiresAt   DateTime                // 24 hours from creation

  // Link to signup code generated after onboarding completion
  signupCode  SignupCode?

  @@index([token])
  @@index([createdBy])
  @@index([expiresAt])
  @@index([used])
}

model SignupCode {
  id                String    @id @default(cuid())
  code              String    @unique // 8-char uppercase code (e.g., "A7X9K2M4")
  used              Boolean   @default(false)
  usedAt            DateTime?
  createdAt         DateTime  @default(now())
  expiresAt         DateTime                // 24 hours from creation

  // Link back to the onboarding token
  onboardingTokenId String    @unique
  onboardingToken   OnboardingToken @relation(fields: [onboardingTokenId], references: [id])

  // Onboarding data collected during flow
  firstName         String?
  lastName          String?
  phone             String?
  state             String?
  w9Url             String?   // Google Drive URL for W-9 document
  w9DriveFileId     String?   // Google Drive file ID

  @@index([code])
  @@index([used])
  @@index([expiresAt])
}
