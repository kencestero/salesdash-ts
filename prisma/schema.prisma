// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NextAuth.js Models
// Docs: https://next-auth.js.org/adapters/prisma

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id               String    @id @default(cuid())
  name             String?
  email            String?   @unique
  emailVerified    DateTime?
  password         String?   // For email/password authentication
  image            String?
  resetToken       String?   @unique // Password reset token
  resetTokenExpiry DateTime? // Token expiration time
  createdAt        DateTime  @default(now())
  currentChallenge String?   // WebAuthn challenge for passkey registration/authentication
  updatedAt        DateTime  @updatedAt

  accounts          Account[]
  sessions          Session[]
  profile           UserProfile?
  trailerRequests   TrailerRequest[]
  chatParticipants  ChatParticipant[]
  credentials       WebAuthnCredential[]
  chatMessages      ChatMessage[]
  sentMessages      InternalMessage[]  @relation("SentMessages")
  receivedMessages  InternalMessage[]  @relation("ReceivedMessages")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Pending User - For "Verify First, Then Create Account" flow
model PendingUser {
  id             String   @id @default(cuid())
  email          String   @unique
  hashedPassword String
  firstName      String
  lastName       String
  phone          String?
  zipcode        String?
  role           String   @default("salesperson") // "owner", "manager", "salesperson"
  managerId      String?  // Selected manager's User ID during signup
  status         String   @default("employee") // "employee" or "freelancer"
  token          String   @unique
  expiresAt      DateTime
  createdAt      DateTime @default(now())

  @@index([token])
  @@index([email])
  @@index([expiresAt])
  @@map("pending_users")
}

// MJ Cargo SalesDash Models

model UserProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  firstName       String?
  lastName        String?
  preferredName   String?  // Preferred name / nickname
  phone           String?
  zipcode         String?
  city            String?
  about           String?  @db.Text // Professional bio / about section
  avatarUrl       String?  @db.Text // Profile avatar/photo URL
  coverUrl        String?  @db.Text // Profile cover/banner image URL
  zip             String?  // Legacy field, use zipcode instead
  salespersonCode String?  @unique // REP12345, SMR12345, or VIP12345
  role            String   @default("salesperson") // "owner", "manager", "salesperson", "director"
  member          Boolean  @default(false) // Join code verified
  needsJoinCode   Boolean  @default(false) // OAuth users who signed up without join code

  // Rep Tracking & Organization
  repCode         String?  @unique // Format: "REP" + 6 digits (e.g., "REP482756"), "REP000000" for freelancers
  managerId       String?  // Links to another User's id (their manager)
  status          String   @default("employee") // "employee" or "freelancer"

  // User Status Controls
  accountStatus   String   @default("active") // "active", "banned", "timeout", "muted"
  banReason       String?  // Reason for ban/timeout
  timeoutUntil    DateTime? // When timeout expires (null if not on timeout)
  mutedUntil      DateTime? // When mute expires (null if not muted)

  // Granular Permissions
  canAccessCRM        Boolean @default(true)
  canAccessInventory  Boolean @default(true)
  canAccessConfigurator Boolean @default(true) // Finance Calculator
  canAccessCalendar   Boolean @default(true)
  canAccessReports    Boolean @default(false) // Advanced reports
  canManageUsers      Boolean @default(false) // Only for owners/directors

  // Manager System Controls
  isAvailableAsManager Boolean @default(false) // Can appear in manager dropdown during signup
  isActive            Boolean @default(true)   // Account active status (for soft-delete/suspension)

  // User Presence Tracking (for chat online/offline status)
  lastSeen   DateTime  @default(now())
  isOnline   Boolean   @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([role])
  @@index([member])
  @@index([salespersonCode])
  @@index([repCode])
  @@index([managerId])
  @@index([accountStatus])
}

// Inventory Management
model Trailer {
  id              String   @id @default(cuid())
  vin             String   @unique // Vehicle Identification Number
  stockNumber     String   @unique // Internal stock number

  // Basic Info
  manufacturer    String   // e.g., "Big Tex", "PJ Trailers"
  model           String
  year            Int
  category        String   // e.g., "Utility", "Dump", "Enclosed", "Gooseneck"

  // Specifications
  length          Float    // in feet
  width           Float    // in feet
  height          Float?   // in feet
  gvwr            Int?     // Gross Vehicle Weight Rating (lbs)
  capacity        Int?     // payload capacity (lbs)
  axles           Int?     // number of axles
  rearDoorType    String?  // Rear door code: R, DD, HDR, SRW, 8'P, R-RW

  // Pricing
  msrp            Float    // Manufacturer's Suggested Retail Price
  salePrice       Float    // Current sale price
  cost            Float    // Dealer cost (sensitive!)
  makeOffer       Boolean  @default(false) // If true, display "MAKE OFFER" instead of sale price
  pricingStatus   String   @default("PRICED") // "PRICED" or "ASK_FOR_PRICING" (when cost is textual)

  // Status
  status          String   @default("available") // "available", "sold", "reserved", "pending"
  location        String?  // Physical location (lot, warehouse)

  // Media
  images          String[] // Array of image URLs
  description     String?  @db.Text
  features        String[] // Array of feature strings

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?  // User ID who added it
  soldAt          DateTime?
  soldBy          String?  // Salesperson ID who sold it

  // Soft-delete & Batch Tracking
  importBatchId   String?   @db.VarChar(36) // UUID for tracking bulk imports
  deletedAt       DateTime? // Soft-delete timestamp

  // Relations
  deals           Deal[]
  creditApps      CreditApplication[]
  quotes          Quote[]

  @@index([status])
  @@index([category])
  @@index([manufacturer])
  @@index([importBatchId])
  @@index([deletedAt])
  @@index([soldBy])
}

// CRM - Customer Relationship Management
model Customer {
  id              String   @id @default(cuid())

  // Personal Info
  firstName       String
  lastName        String
  email           String?  @unique
  phone           String?

  // Address
  street          String?
  city            String?
  state           String?
  zipcode         String?

  // Business Info
  companyName     String?
  businessType    String?

  // Lead Management - NEW FIELDS
  assignedTo      String?  // KEEP FOR NOW - will migrate to assignedToId
  assignedToId    String?  // Primary salesperson ID
  assignedToName  String?  // Primary salesperson name (Assigned Manager - Column F)
  salesRepName    String?  // Sales Rep name (Column B)
  backupRepId     String?  // Secondary rep if needed
  lastContactDate DateTime?
  nextFollowUpDate DateTime?

  // Lead Info
  source          String?
  status          String   @default("new") // "new", "contacted", "qualified", "applied", "approved", "dead", "won"

  // Trailer Requirements - NEW FIELDS
  trailerSize     String?
  trailerType     String?
  stockNumber     String?
  financingType   String?  // "cash", "finance", "rto"
  isFactoryOrder  Boolean  @default(false) // KEEPING for backward compatibility

  // Credit Application Status - NEW FIELDS
  hasAppliedCredit Boolean @default(false)
  creditAppStatus String?  // "not_applied", "applied", "approved", "declined"
  applied         Boolean @default(false) // Google Sheets Column H - Applied status
  dateApplied     DateTime? // Google Sheets Column I - Date Applied

  // Tags for segmentation
  tags            String[]

  // Notes
  notes           String?  @db.Text
  managerNotes    String?  @db.Text // Google Sheets Column K - Manager Notes
  repNotes        String?  @db.Text // Google Sheets Column L - Rep Notes

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastContactedAt DateTime?

  // Relations
  deals           Deal[]
  creditApps      CreditApplication[]
  activities      Activity[]
  emails          Email[]
  quotes          Quote[]
  leadNotes       LeadNote[]  // NEW RELATION

  @@index([email])
  @@index([status])
  @@index([assignedTo])
  @@index([assignedToId])
  @@index([nextFollowUpDate])
  @@index([hasAppliedCredit])
}

// Deal/Opportunity Tracking
model Deal {
  id              String   @id @default(cuid())

  // Customer & Trailer
  customerId      String
  trailerId       String?  // Nullable in case of custom orders

  // Deal Info
  dealNumber      String   @unique
  status          String   @default("pending") // "pending", "financing", "approved", "closed", "lost"
  dealType        String   // "cash", "finance", "trade"

  // Pricing
  offeredPrice    Float
  finalPrice      Float?
  tradeInValue    Float?
  tradeInDesc     String?  @db.Text
  deposit         Float?

  // Finance Info
  financeAmount   Float?
  downPayment     Float?
  apr             Float?
  term            Int?     // months
  monthlyPayment  Float?

  // Ownership
  salespersonId   String
  managerId       String?  // Manager who approved

  // Timeline
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  closedAt        DateTime?
  expectedCloseDate DateTime?

  // Notes
  notes           String?  @db.Text

  // Relations
  customer        Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  trailer         Trailer? @relation(fields: [trailerId], references: [id])

  @@index([customerId])
  @@index([trailerId])
  @@index([salespersonId])
  @@index([status])
}

// Credit Application System
model CreditApplication {
  id              String   @id @default(cuid())
  appNumber       String   @unique

  // Shareable Link
  shareToken      String?  @unique // For public access
  shareEnabled    Boolean  @default(true)
  expiresAt       DateTime? // Optional expiration

  // Customer Info
  customerId      String?  // Optional - public forms may create new customers
  trailerId       String?

  // Personal Info (from form)
  firstName       String
  lastName        String
  email           String
  phone           String
  street          String?
  city            String?
  state           String?
  zipcode         String?

  ssn             String?  // Encrypted! Handle with care
  dob             DateTime?
  driverLicense   String?
  dlState         String?

  // Employment
  employer        String?
  jobTitle        String?
  employmentYears Int?
  monthlyIncome   Float?

  // Housing
  housingStatus   String?  // "own", "rent", "other"
  monthlyPayment  Float?
  yearsAtAddress  Int?

  // Equipment Details
  requestedAmount Float?
  requestedTerm   Int?      // months
  equipmentType   String?   // "utility", "dump", "enclosed", etc.
  equipmentDesc   String?   @db.Text

  // References
  references      Json?    // Array of reference objects

  // E-Signature & Legal
  signatureData   String?  @db.Text // Base64 signature image
  signedAt        DateTime?
  ipAddress       String?
  userAgent       String?
  legalConsent    Boolean  @default(false)
  legalText       String?  @db.Text // What they agreed to

  // Status
  status          String   @default("pending") // "pending", "submitted", "approved", "declined", "needs_review"
  submittedAt     DateTime?
  decidedAt       DateTime?

  // Approval Details
  approvedAmount  Float?
  approvedTerm    Int?
  approvedApr     Float?
  lender          String?  // Which finance company approved

  // Notes
  notes           String?  @db.Text

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?  // Salesperson who created it (nullable for public submissions)

  // Relations
  customer        Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  trailer         Trailer? @relation(fields: [trailerId], references: [id])

  @@index([customerId])
  @@index([status])
  @@index([createdBy])
  @@index([shareToken])
  @@index([email])
}

// Activity Tracking (for CRM)
model Activity {
  id              String   @id @default(cuid())

  // Related To
  customerId      String?
  userId          String?  // User who performed activity

  // Activity Details
  type            String   // "call", "email", "meeting", "note", "task"
  subject         String
  description     String?  @db.Text

  // Status (for tasks)
  status          String?  // "pending", "completed", "cancelled"
  dueDate         DateTime?
  completedAt     DateTime?

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  customer        Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([userId])
  @@index([type])
  @@index([dueDate])
}

// Email System
model Email {
  id              String   @id @default(cuid())

  // Email Details
  from            String
  to              String[]
  cc              String[]
  bcc             String[]
  subject         String
  body            String   @db.Text
  htmlBody        String?  @db.Text

  // Attachments
  attachments     Json?    // Array of attachment metadata

  // Status
  status          String   @default("draft") // "draft", "sent", "failed", "scheduled"
  sentAt          DateTime?
  scheduledFor    DateTime?

  // Tracking
  opened          Boolean  @default(false)
  openedAt        DateTime?
  clicked         Boolean  @default(false)
  clickedAt       DateTime?

  // Relations
  customerId      String?
  userId          String   // User who sent/created

  // Template
  templateId      String?

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  customer        Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@index([customerId])
  @@index([userId])
  @@index([status])
  @@index([sentAt])
}

// Email Templates
model EmailTemplate {
  id              String   @id @default(cuid())
  name            String
  subject         String
  body            String   @db.Text
  htmlBody        String?  @db.Text

  // Variables (e.g., {{firstName}}, {{trailerModel}})
  variables       String[]

  // Category
  category        String?  // "follow-up", "thank-you", "reminder", "marketing"

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String

  @@index([category])
}

// Finance Quote System
enum PricingMode {
  CASH
  FINANCE
  RTO
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  CONVERTED
  EXPIRED
  REJECTED
}

enum QuoteAction {
  CREATED
  VIEWED_BY_REP
  VIEWED_BY_CUSTOMER
  EDITED
  LINK_GENERATED
  LINK_CLICKED
  PDF_GENERATED
  PDF_DOWNLOADED
  EMAIL_SENT
  SMS_SENT
  FORMULA_COPIED
  ACCEPTED
  REJECTED
  EXPIRED
  CONVERTED_TO_SALE
}

model Quote {
  id              String       @id @default(cuid())
  userId          String       // Rep who created the quote
  salespersonCode String       // Rep's unique code for filtering

  // Related entities
  trailerId       String?
  trailer         Trailer?     @relation(fields: [trailerId], references: [id])

  customerId      String?
  customer        Customer?    @relation(fields: [customerId], references: [id])

  // Pricing mode
  mode            PricingMode  @default(FINANCE)

  // Shared fields
  unitPrice       Float
  downPayment     Float        @default(0)
  taxRate         Float        // Percentage (e.g., 8.25)
  fees            Float        @default(0)
  termMonths      Int

  // Finance-specific fields
  apr             Float?
  monthlyPayment  Float?
  totalInterest   Float?
  principal       Float?

  // RTO-specific fields
  monthlyRent     Float?
  monthlyTax      Float?
  docFee          Float?
  buyoutFee       Float?
  rtoPrice        Float?

  // Cash-specific
  totalCash       Float?

  // Status and lifecycle
  status          QuoteStatus  @default(DRAFT)
  expiresAt       DateTime

  // Sharing settings
  shareToken      String?      @unique
  shareEnabled    Boolean      @default(false)
  visibilitySettings Json?     // { showAPR: false, showFees: true, ... }

  // Metadata
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  activities      QuoteActivity[]

  @@index([salespersonCode])
  @@index([status])
  @@index([trailerId])
  @@index([customerId])
  @@index([userId])
  @@index([expiresAt])
}

model QuoteActivity {
  id            String      @id @default(cuid())
  quoteId       String
  quote         Quote       @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  // Actor information
  userId        String?
  salespersonCode String?
  actorType     String      // "REP" | "CUSTOMER" | "SYSTEM"
  actorName     String?

  // Action details
  action        QuoteAction
  changes       Json?       // Field-level changes for EDITED action

  // Request metadata
  ipAddress     String?
  userAgent     String?
  durationMs    Int?        // Time spent viewing (for VIEWED actions)

  // Timestamp
  occurredAt    DateTime    @default(now())

  @@index([quoteId])
  @@index([salespersonCode])
  @@index([action])
  @@index([occurredAt])
}

model PricingPolicy {
  id                    Int      @id @default(1)

  // RTO defaults
  rtoBaseMarkupUsd      Float    @default(1400)
  rtoMonthlyFactor      Float    @default(0.035)  // 3.5%
  rtoMinDownUsd         Float    @default(200)
  rtoDocFeeUsd          Float    @default(99)
  rtoBuyoutFeeUsd       Float    @default(250)
  rtoDefaultTermMonths  Int      @default(36)

  // Finance defaults
  defaultApr            Float    @default(8.99)
  defaultTermMonths     Int      @default(60)

  // Cash defaults
  defaultFees           Float    @default(125)

  // Quote settings
  quoteExpirationDays   Int      @default(90)

  updatedAt             DateTime @updatedAt
}

// Inventory Upload Report System
model UploadReport {
  id                String   @id @default(cuid())

  // Upload Info
  fileName          String
  manufacturer      String   // "Diamond Cargo", "Quality Cargo", etc.
  uploadedBy        String   // User ID who uploaded

  // Summary Stats
  totalInUpload     Int      // Total trailers in the uploaded file
  newTrailers       Int      // Newly added trailers (VINs not in DB before)
  updatedTrailers   Int      // Existing trailers that were updated
  removedTrailers   Int      // Trailers that were in DB but not in upload (potentially sold)

  // Detailed Lists (stored as JSON for flexibility)
  newVins           String[] // Array of newly added VIN numbers
  updatedVins       String[] // Array of updated VIN numbers
  removedVins       String[] // Array of removed VIN numbers (potentially sold)

  // Additional metadata
  processingTime    Int?     // Time taken to process in milliseconds
  errors            Json?    // Any errors encountered during processing

  // Timestamps
  createdAt         DateTime @default(now())

  @@index([manufacturer])
  @@index([uploadedBy])
  @@index([createdAt])
}

// Import Log - Track each inventory import for rollback capability
model ImportLog {
  id        String   @id @default(cuid())
  batchId   String   @unique // UUID for the import batch
  supplier  String   // "Diamond Cargo", "Quality Cargo", "Panther Cargo"
  created   Int      // Number of new trailers created
  updated   Int      // Number of existing trailers updated
  skipped   Int      // Number of rows skipped (invalid data)
  userId    String   // User ID who performed the import
  createdAt DateTime @default(now())

  @@index([batchId])
  @@index([userId])
  @@index([createdAt])
}

// Calendar & Events System
model CalendarEvent {
  id              String   @id @default(cuid())

  // Event Details
  title           String
  description     String?  @db.Text
  start           DateTime
  end             DateTime
  allDay          Boolean  @default(false)

  // Event Type & Category
  eventType       String   // "personal" or "company"
  category        String   // "business", "personal", "holiday", "family", "meeting", "etc"

  // Ownership & Permissions
  userId          String?  // User who owns it (null for company-wide events)
  createdBy       String   // User ID who created it
  createdByRole   String?  // Role of creator ("owner", "manager", "salesperson")

  // Company Announcement specific fields
  isAnnouncement  Boolean  @default(false)
  visibleToRoles  String[] // Empty array = visible to all roles

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Indexes
  @@index([userId])
  @@index([eventType])
  @@index([category])
  @@index([start])
  @@index([end])
  @@index([isAnnouncement])
}

// Lead Notes - Separate from general notes for better tracking
model LeadNote {
  id              String   @id @default(cuid())

  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  authorId        String   // Who wrote the note
  authorName      String   // Display name of author
  authorRole      String   // "salesperson", "manager", "director", "owner"

  content         String   @db.Text
  noteType        String   @default("general") // "general", "follow_up", "manager_review", "status_change"

  isPrivate       Boolean  @default(false) // For sensitive notes

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([customerId])
  @@index([authorId])
  @@index([createdAt])
}

model TrailerRequest {
  id           String   @id @default(cuid())
  userId       String
  manufacturer String
  purpose      String
  vin          String?
  message      String   @db.Text
  status       String   @default("pending")
  assignedTo   String?
  response     String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id])
  @@index([status])
}

// Request Tool - Public request submissions
enum RequestStatus {
  PENDING
  SENT
  FAILED
}

model RequestLog {
  id                String        @id @default(cuid())
  createdAt         DateTime      @default(now())
  email             String
  fullName          String
  zip               String?
  manufacturer      String
  purpose           String
  message           String        @db.Text
  lang              String        @default("en")
  ip                String?
  userAgent         String?
  status            RequestStatus @default(PENDING)
  error             String?

  // Rep tracking fields
  submittedByUserId String?       // Salesperson who submitted
  submittedByName   String?       // Salesperson full name
  submittedByEmail  String?       // Salesperson email
  repCode           String?       // REP482756
  managerId         String?       // Manager's User ID
  managerNotified   Boolean       @default(false) // Was manager notified?

  @@index([createdAt])
  @@index([email])
  @@index([manufacturer])
  @@index([purpose])
  @@index([submittedByUserId])
  @@index([repCode])
  @@index([managerId])
}

// Help Center System
model HelpArticle {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  content     String   @db.Text
  excerpt     String?  @db.Text
  category    String   // "request-tool", "crm", "inventory", "finance", "general", etc.
  keywords    String[] // For search optimization
  isPinned    Boolean  @default(false) // Show at top of search results
  isPublished Boolean  @default(true)
  viewCount   Int      @default(0)
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String   // User ID who created
  
  @@index([category])
  @@index([isPublished])
  @@index([isPinned])
  @@index([slug])
}

// Real-Time Chat System
model ChatThread {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  subject   String?

  // Group Chat Fields
  isGroup      Boolean  @default(false)
  groupName    String?
  groupAvatar  String?
  isPublic     Boolean  @default(false)
  inviteToken  String?  @unique
  createdBy    String?  // User ID who created the group

  participants ChatParticipant[]
  messages     ChatMessage[]

  @@index([isGroup])
  @@index([isPublic])
  @@index([inviteToken])
}

model ChatParticipant {
  id       String     @id @default(cuid())
  thread   ChatThread @relation(fields: [threadId], references: [id])
  threadId String
  userId   String // maps to User.id
  user     User       @relation(fields: [userId], references: [id])
  isAdmin  Boolean    @default(false) // Group chat admin privileges

  @@unique([threadId, userId])
  @@index([threadId])
  @@index([userId])
}

model ChatMessage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  body      String   @db.Text
  senderId  String   // maps to User.id
  sender    User     @relation(fields: [senderId], references: [id])

  thread   ChatThread @relation(fields: [threadId], references: [id])
  threadId String

  attachments ChatAttachment[]

  @@index([threadId])
  @@index([senderId])
}

model ChatAttachment {
  id        String      @id @default(cuid())
  fileUrl   String
  fileName  String
  mimeType  String
  message   ChatMessage @relation(fields: [messageId], references: [id])
  messageId String

  @@index([messageId])
}

// Sync Log for tracking Google Sheets import runs
model SyncLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  startedAt DateTime
  durationMs Int
  scanned   Int
  inserted  Int
  updated   Int
  skipped   Int
  errors    Int
  errorDetails Json?
  actor     String   // email or 'token' if using token auth
  source    String   @default("google_sheets") // for future extensibility
  
  @@index([createdAt])
  @@index([source])
}

// WebAuthn Credentials (Passkeys)
model WebAuthnCredential {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  credentialId   String   @unique    // base64url
  publicKey      String               // base64url
  counter        Int
  deviceType     String?
  backedUp       Boolean?
  transports     String?              // json array string
  createdAt      DateTime @default(now())
  lastUsedAt     DateTime @updatedAt

  @@index([userId])
}

// Internal Messaging System (for header inbox dropdown)
model InternalMessage {
  id          String   @id @default(cuid())
  senderId    String
  receiverId  String
  subject     String?
  message     String   @db.Text
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  sender      User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver    User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([read])
  @@index([createdAt])
  @@map("internal_messages")
}
